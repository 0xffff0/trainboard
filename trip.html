<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Zuginformationen</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="./assets/css/styles.css">
	<link rel="stylesheet" href="./assets/css/line-colors.css">
	<link rel="shortcut icon" type="image/x-icon" href="./assets/branding/favicon.ico">
	<link rel="manifest" href="/manifest.json" type="application/json" >
	<meta name="theme-color" content="#000">
</head>

<body>

<center>
<noscript> You need to enable JavaScript to run this app. </noscript>

<div class="navbar" id="navbar"><div class="tabs"><span class="active">&nbsp;Zuginformationen&nbsp;</a></div><div class="iconbar bigonly"><a href="#" onclick="history.go(-1)">Schließen</a></div><div class="iconbar"><a href="#" onclick="history.go(-1)"><img src="./assets/icons/close.svg" class="mediumicon"></a></div></div>

<br>

<div class="tripcontainer">
	<div class="container">
		<div class="left-div">
			<div id="destination" class="big"></div>
			<div id="stopovers"></div>
		</div>
		<div class="right-div lineview">
			<div id="selectedDepartureTime" class="departtime"></div>
			<div id="lineInfo"></div>
			<span id="trainNr">Lade Fahrplandaten...</span>
			<br><br>
		</div>
		
		
	</div>
	<span id="notice"></span>
	
	<br>
	
	<div class="coacheswrapper" id="coacheswrapper">
		<div id="blocksContainer" class="coachescontent"></div>
	</div>
	
	<b>Wagenreihung - KNOWN ISSUES:</b>
	<ul>
		<li>Only the first element in "allFahrzeugaustattung" for each carriage will be shown</li>
		<li>If the train contains an locomotive nothing will be displayed</li>
		<li>Not yet full icon set: Just open a Issue on GitHub if you find one missing.</li>
	</ul>
	<a href="https://github.com/hoolycrash/trainboard/blob/main/trip.html" style="color: #112053; "><u>View this page on GitHub.</u></a><br><br>
	
	

</div>

</center>

<script>
// This whole thing loads data from db-rest/stops/{id}/departures
async function fetchAndDisplayData() {
	// Extract params from url
	const urlParams = new URLSearchParams(window.location.search);
	const tripId = urlParams.get('id'); //trip id needed to identify the train
	const stationId = urlParams.get('station'); //station id to identify the station which the user came from when clicking a train (hope you understand this phahahahaha)

	try {
		// Load trip-data from API
		const response = await fetch(`https://v6.db.transport.rest/trips/${tripId || ''}?stopovers=true&remarks=true&polyline=false&language=de`);
		const data = await response.json();
		
		const tripid = data.trip.line.fahrtNr;
		var zugnummer = tripid;//Train Nr (Zugnummer)
		
		document.getElementById('trainNr').innerHTML = '<b>Zugnummer:</b> ' + zugnummer;

		

		// Create the flowing text with the next stations of this trip
		let flowText = "";
		let foundStation = false;

		data.trip.stopovers.forEach(stopover => {
			if (stopover.stop.id == stationId) {
				foundStation = true;

				// Departure time at the stop from where you clicked on the train
				const selectedDepartureTimeDiv = document.getElementById('selectedDepartureTime');
				if (selectedDepartureTimeDiv) {
					const selectedTime = new Date(stopover.departure);
					const selectedFormattedTime = `<b>${selectedTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}</b>`;
					selectedDepartureTimeDiv.innerHTML = selectedFormattedTime;
					
					// converting departing-time to YYYYMMDDHHMM format for the api request
					const selecteddepartTime = new Date(stopover.plannedDeparture);
					const year = selecteddepartTime.getFullYear();
					const month = String(selecteddepartTime.getMonth() + 1).padStart(2, '0');
					const day = String(selecteddepartTime.getDate()).padStart(2, '0');
					const hours = String(selecteddepartTime.getHours()).padStart(2, '0');
					const minutes = String(selecteddepartTime.getMinutes()).padStart(2, '0');
					const convertedtime = `${year}${month}${day}${hours}${minutes}`;
					var datetime = convertedtime;
		
		
		fetch(`https://ist-wr.noncd.db.de/wagenreihung/1.0/${zugnummer}/${datetime}`)
            .then(response => response.json())
            .then(data => {
			
			// Check for valid JSON
                if (data.error) {
                    document.getElementById('notice').innerHTML = '<br><br>Wagenreihung für diesen Zug nicht verfügbar.<br><br>';
					document.getElementById('coacheswrapper').classList.add('hidden');

                }
				
				
                const allFahrzeuggruppe = data.data.istformation.allFahrzeuggruppe;

                
                const firstElementsMap = new Map();
                allFahrzeuggruppe.forEach(gruppe => {
                    gruppe.allFahrzeug.forEach(fahrzeug => {
                        const positioningruppe = fahrzeug.positioningruppe;
                        if (!firstElementsMap.has(positioningruppe)) {
                            firstElementsMap.set(positioningruppe, fahrzeug);
                        }
                    });
                });

                // Sort elements
                const sortedFahrzeuge = Array.from(firstElementsMap.values()).sort((a, b) => {
                    return parseInt(a.positioningruppe) - parseInt(b.positioningruppe);
                });

                const blocksContainer = document.getElementById('blocksContainer');

                sortedFahrzeuge.forEach(fahrzeug => {
                    const positioningruppe = fahrzeug.positioningruppe;
					const wagenordnungsnummer = fahrzeug.wagenordnungsnummer;
                    const ausstattung = fahrzeug.allFahrzeugausstattung[0];
                    const ausstattungsart = ausstattung.ausstattungsart;
                    const anzahl = ausstattung.anzahl;
                    const bezeichnung = ausstattung.bezeichnung;
                    const status = ausstattung.status;
                    const kategorie = fahrzeug.kategorie;

                    const ausstattungsDiv = document.createElement('div');
                    ausstattungsDiv.classList.add('coach');

                    if (ausstattungsart !== 'KLIMA') {
                        ausstattungsDiv.innerHTML = `${wagenordnungsnummer}<br><img src="assets/icons/${kategorie}.svg"><img src="assets/icons/${ausstattungsart}.svg">`;
                    } else {
                        ausstattungsDiv.innerHTML = `${wagenordnungsnummer}<br><img src="assets/icons/${kategorie}.svg">`;
                    }

                    blocksContainer.appendChild(ausstattungsDiv);
                });
            })
            .catch(error => {
                console.error('Fehler beim Abrufen der Daten:', error);
            });
		
					
					
				} else {
					console.error('Div mit der ID "selectedDepartureTime" nicht gefunden.');
				}

				return;
			}

			if (foundStation) {
				// Create an item in the flowing text
				const time = stopover.arrival ? new Date(stopover.arrival) : new Date(stopover.departure);
				const timeType = stopover.arrival ? 'ARRIVAL' : 'DEPARTURE';
				const formattedTime = `${time.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`;
				flowText += `${formattedTime} <b>${stopover.stop.name}</b> | `;
			}
		});

		// Show the destination of the train in destinations div (the big title on top)
		
		const destinationStopover = data.trip.stopovers.find(stopover => stopover.stop.id === data.trip.destination.id);
		if (destinationStopover) {
			const destinationDiv = document.getElementById('destination');
			if (destinationDiv) {
				destinationDiv.innerHTML = `<div>&#10132; ${destinationStopover.stop.name}</div>`;
			} else {
				console.error('Div mit der ID "destination" nicht gefunden.');
			}
		}
		
		
		
		
		



		// Push the flowing text to the div to show
		const stopoversDiv = document.getElementById('stopovers');
		if (stopoversDiv) {
			//Remove the last ' | ' because its not needed due there is no following station
			stopoversDiv.innerHTML = flowText.slice(0, -2);
		} else {
			console.error('Div mit der ID "stopovers" nicht gefunden.');
		}

		// Left div with departing train and linenumber
		const lineInfoDiv = document.getElementById('lineInfo');
		if (lineInfoDiv) {
			lineInfoDiv.innerHTML = `<div class="biglinebadge ${data.trip.line.product}  ${data.trip.line.name.replace(/\s/g, '')}${data.trip.line.operator.id} ${data.trip.line.productName}">${data.trip.line.name}  </div>`;

		} else {
			console.error('Div mit der ID "lineInfo" nicht gefunden.');
		}
		
		
	} catch (error) {
		console.error('Fehler beim Abrufen der Daten:', error);
	}
	
	
}



fetchAndDisplayData();

//const zugnummer = jsonData.trip.line.fahrtNr;



</script>

</body>
</html>