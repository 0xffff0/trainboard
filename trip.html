<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuginformationen | Trainboard</title>
    <link rel="stylesheet" href="./assets/css/styles.css">
    <link rel="stylesheet" href="./assets/css/dark-styles.css">
    <link rel="stylesheet" href="./assets/css/line-colors.css">
    <link rel="shortcut icon" type="image/x-icon" href="./assets/branding/favicon.ico">
    <link rel="manifest" href="/manifest.json" type="application/json">
    <meta name="theme-color" content="#000">
    <meta name="robots" content="noindex">
</head>
<body>
<center>
    <noscript>You need to enable JavaScript to run this app.</noscript>

    <nav id="navbar">
        <div class="tabs"><span class="active">&nbsp;Zuginformationen&nbsp;</span></div>
        <div class="iconbar bigonly"><a href="#" onclick="history.go(-1)">Schließen</a></div>
        <div class="iconbar"><a href="#" onclick="history.go(-1)"><img src="./assets/icons/close.svg" class="mediumicon"></a></div>
    </nav>

    <br>

    <div class="tripcontainer">
        <div class="container">
            <div class="left-div">
                <div id="destination" class="big"></div>
                <div id="stopovers"></div>
            </div>
            <div class="right-div lineview">
                <div id="selectedDepartureTime" class="departtime"></div>
                <div id="lineInfo"></div>
                <span id="trainNr">Lade Fahrplandaten...</span>
                <br><br>
            </div>
        </div>
        <span id="notice"></span>
        <br>
    </div>

    <div class="coacheswrapper" id="coacheswrapper">
        <div id="blocksContainer" class="coachescontent"></div>
    </div>

    <div class="hidden" id="git-info">
        <b>Wagenreihung - KNOWN ISSUES:</b>
        <ul style="list-style: none">
            <li>Not yet full icon set: Just open an Issue on GitHub if you find one missing.</li>
            <li>Find Bug -> <u id="git-error">Open new Issue on GitHub</u></li>
        </ul>
        <a href="https://github.com/hoolycrash/trainboard/blob/main/trip.html" class="black"><u>View this page on GitHub.</u></a><br><br>
    </div>
    <br><br><br>
</center>

<script>
    async function fetchAndDisplayData() {
        const urlParams = new URLSearchParams(window.location.search);
        const tripId = getTripIdFromUrl(window.location.href);
        const stationValue = getParameterByName('station', window.location.href);
        const stationId = stationValue;

        try {
            const response = await fetch(`http://168.119.111.217:3000/trip?tripId=${encodeURIComponent(tripId)}&stationId=${stationId}`);
            const data = await response.json();
            const trip = data.trip;
            const zugnummer = trip.line.fahrtNr;

            let flowText = "";
            let foundStation = false;

            trip.stopovers.forEach(stopover => {
                if (stopover.stop.id == stationId) {
                    foundStation = true;
                    const selectedDepartureTimeDiv = document.getElementById('selectedDepartureTime');
                    if (selectedDepartureTimeDiv) {
                        let selectedTime = new Date(stopover.departure || stopover.arrival);
                        const selectedFormattedTime = `<b>${selectedTime.toLocaleTimeString('de-DE', {
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</b>`;
                        let selectedPlannedTime = new Date(stopover.plannedDeparture || stopover.plannedArrival);
                        const selectedFormattedPlannedTime = `<b>${selectedPlannedTime.toLocaleTimeString('de-DE', {
                            hour: '2-digit',
                            minute: '2-digit'
                        })}</b>`;
                        selectedDepartureTimeDiv.innerHTML = (stopover.departure == stopover.plannedDeparture) ? selectedFormattedTime : `<s class='disabled'>${selectedFormattedPlannedTime}</s><br>${selectedFormattedTime}`;
                    }
                    return;
                }
                if (foundStation) {
                    if (stopover.cancelled == true && stopover.arrival == null && stopover.departure == null) {
                        flowText += `<a href="departure.html?station=${stopover.stop.id}" class="red"><s><b>${stopover.stop.name}</b></s></a> | `;
                    } else {
                        // Create an item in the flowing text
                        const time = stopover.arrival ? new Date(stopover.arrival) : new Date(stopover.departure);
                        const timeType = stopover.arrival ? 'ARRIVAL' : 'DEPARTURE';
                        const formattedTime = `${time.toLocaleTimeString('de-DE', {
                            hour: '2-digit',
                            minute: '2-digit'
                        })}`;
                        flowText += `<a href="departure.html?station=${stopover.stop.id}" class="traintimetable">${formattedTime} <b>${stopover.stop.name}</b></a> | `;
                    }
                }
            });


            const destinationDiv = document.getElementById('destination');
            const destinationStopover = trip.stopovers.find(stopover => stopover.stop.id === trip.destination.id);
            if (destinationDiv && destinationStopover) {
                destinationDiv.innerHTML = `<div>&#10132; ${destinationStopover.stop.name}</div>`;
            }

            const stopoversDiv = document.getElementById('stopovers');
            if (stopoversDiv) {
                stopoversDiv.innerHTML = flowText.slice(0, -2);
            }

            const lineInfoDiv = document.getElementById('lineInfo');
            if (lineInfoDiv) {
                let entry = trip;
                let linebadge = `<div class="biglinebadge ${entry.line.product} ${entry.line.name.replace(/\s/g, '')}${entry.line.operator.id} ${entry.line.operator.id} ${entry.line.productName}"><a href="https://bahn.expert/details/${zugnummer}/?evaNumberAlongRoute=${stationId}">${entry.line.name}</div>`;
                lineInfoDiv.innerHTML = linebadge;
            }

            document.getElementById('trainNr').innerHTML = `<a href="https://bahn.expert/details/${zugnummer}/?evaNumberAlongRoute=${stationId}" class="black"><b>Zugnummer:</b> <u>${zugnummer}</u></a>`;

            const plannedDeparture = trip.stopovers.find(stopover => stopover.stop.id == stationId).plannedDeparture;
            const datetime = new Date(plannedDeparture);
            const formattedDatetime = `${datetime.getFullYear()}${(datetime.getMonth() + 1).toString().padStart(2, '0')}${datetime.getDate().toString().padStart(2, '0')}${datetime.getHours().toString().padStart(2, '0')}${datetime.getMinutes().toString().padStart(2, '0')}`;

            fetchtraincomposition(zugnummer, formattedDatetime, stationId);
        } catch (error) {
            console.error('Fehler beim Abrufen der Daten:', error);
        }
    }

    async function fetchtraincomposition(zugnummer, datetime, stationId) {
        try {
            const response = await fetch(`https://ist-wr.noncd.db.de/wagenreihung/1.0/${zugnummer}/${datetime}`);
            const data = await response.json();

            if (data.error || data.data.istformation.halt.evanummer !== stationId) {
                document.getElementById('notice').innerHTML = '<br><br>Wagenreihung für diesen Zug nicht verfügbar.<br><br>';
                document.getElementById('coacheswrapper').classList.add('hidden');
                return;
            }

            document.getElementById('git-info').className = '';
            document.getElementById('git-error').innerHTML = `<a href="https://github.com/hoolycrash/trainboard/issues/new?title=Bug%20Wagenreihung:&body=Train:${zugnummer}%20Datetime:${datetime}%20Station:${stationId}" target="_blank" class="black">Open new Issue with Train data on Github</a>`;
            rendertraincomposition(data.data.istformation);
        } catch (error) {
            console.error('Fehler beim Abrufen der Wagenreihung:', error);
        }
    }

    function rendertraincomposition(data) {
        const blocksContainer = document.getElementById('blocksContainer');
        blocksContainer.innerHTML = "";

        const imgpath = 'assets/icons/carriage';
        const allFahrzeuggruppe = data.allFahrzeuggruppe;

        // Render train composition
        allFahrzeuggruppe.forEach(fahrzeuggruppe => {
            let setLOK = false;

            fahrzeuggruppe.allFahrzeug.forEach((fahrzeug, j) => {
                const ausstattungsDiv = document.createElement('div');
                ausstattungsDiv.classList.add('coach');
                ausstattungsDiv.style.flexBasis = `${fahrzeug.positionamhalt.endeprozent - fahrzeug.positionamhalt.startprozent}%`;

                let showIMG = true;

                ausstattungsDiv.classList.add('fzg' + fahrzeug.fahrzeugnummer);

                if (setLOK) {
                    ausstattungsDiv.classList.add('head');
                    setLOK = false;
                }

                if (fahrzeug.kategorie === "LOK") {
                    ausstattungsDiv.classList.add('lok');
                    ausstattungsDiv.innerHTML = `LOK`;
                    setLOK = true;
                    showIMG = false;
                }

                if (j === 0 && fahrzeug.kategorie !== "LOK") {
                    if (fahrzeug.kategorie === "TRIEBKOPF" || fahrzeug.kategorie.includes("STEUERWAGEN")) {
                        ausstattungsDiv.classList.add('steuerHead');
                        if (fahrzeug.kategorie === "TRIEBKOPF") {
                            showIMG = false;
                        }
                    } else {
                        ausstattungsDiv.classList.add('head');
                    }
                }

                if (j === fahrzeuggruppe.allFahrzeug.length - 1 && fahrzeug.kategorie !== "LOK") {
                    if (fahrzeug.kategorie === "TRIEBKOPF" || fahrzeug.kategorie.includes("STEUERWAGEN")) {
                        ausstattungsDiv.classList.add('steuerBack');
                        if (fahrzeug.kategorie === "TRIEBKOPF") {
                            showIMG = false;
                        }
                    } else {
                        ausstattungsDiv.classList.add('back');
                    }
                }

                if (j === fahrzeuggruppe.allFahrzeug.length - 2 && fahrzeuggruppe.allFahrzeug[j + 1].kategorie === "LOK") {
                    ausstattungsDiv.classList.add('back');
                }

                if (j === 0 && fahrzeuggruppe.allFahrzeug.length - 1 === 0) {
                    if (fahrzeuggruppe.allFahrzeug.length === 1 || getVehicleType(fahrzeuggruppe.fahrzeuggruppebezeichnung)[2] === "650") {
                        ausstattungsDiv.classList.add('single');
                    } else {
                        if (fahrzeuggruppe.allFahrzeug.length > 1 && fahrzeug.kategorie !== "LOK") {
                            ausstattungsDiv.className = 'coach';
                            if (fahrzeuggruppe.allFahrzeug.length === 2 && allFahrzeuggruppe[0].allFahrzeug[0].kategorie === "LOK") {
                                ausstattungsDiv.classList.add('head');
                            }
                            if (fahrzeuggruppe.allFahrzeug.length === allFahrzeuggruppe.length - 2 && allFahrzeuggruppe[fahrzeuggruppe.length + 1].allFahrzeug[0].kategorie === "LOK") {
                                ausstattungsDiv.classList.add('back');
                            }
                            if (fahrzeuggruppe.allFahrzeug.length === allFahrzeuggruppe.length - 1 && fahrzeug.kategorie !== "LOK") {
                                if (fahrzeug.kategorie.includes("STEUERWAGEN")) {
                                    ausstattungsDiv.classList.add('steuerBack');
                                } else {
                                    ausstattungsDiv.classList.add('back');
                                }
                            }
                        }
                    }
                }

                if (fahrzeug.status === "GESCHLOSSEN") {
                    ausstattungsDiv.innerHTML = `x`;
                    showIMG = false;
                }

                if (showIMG) {
                    ausstattungsDiv.innerHTML = `<div class='sector'>${fahrzeug.fahrzeugsektor}`;
                    ausstattungsDiv.innerHTML += `${fahrzeug.wagenordnungsnummer}<br><img src="${imgpath}/${fahrzeug.kategorie}.svg">`;
                    fahrzeug.allFahrzeugausstattung.forEach(ausstattung => {
                        if (!["KLIMA"].includes(ausstattung.ausstattungsart)) {
                            ausstattungsDiv.innerHTML += `<img src="${imgpath}/${ausstattung.ausstattungsart}.svg">`;
                        }
                    });
                }
                blocksContainer.appendChild(ausstattungsDiv);
            });
        });
    }

    function getTripIdFromUrl(url) {
        const queryParams = url.split("?")[1];
        return queryParams.split("&")[0].replace("id=", "");
    }

    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        const results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    fetchAndDisplayData();
</script>

</body>
</html>
